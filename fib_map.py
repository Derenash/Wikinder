import re

initial_string = "#kdl_name = Fib_map_buld\nApps.Fib.Map.Build : Apps.Fib.Map {\n  (\n    Data.BaseTree.Qui.tie\n      Apps.Fib.Map.Build.qui_00\n      Apps.Fib.Map.Build.qui_01\n      Apps.Fib.Map.Build.qui_02\n      Apps.Fib.Map.Build.qui_03\n      Apps.Fib.Map.Build.qui_04\n  )\n}\n#kdl_name = Fib_map_bq00\nApps.Fib.Map.Build.qui_00 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 ] U120 {\n  (Data.BaseTree.Bin.tie \n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_00 Apps.Fib.Map.Build.bin_01)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_02 Apps.Fib.Map.Build.bin_03)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_04 Apps.Fib.Map.Build.bin_05)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_06 Apps.Fib.Map.Build.bin_07)\n      )\n    )\n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_08 Apps.Fib.Map.Build.bin_09)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_10 Apps.Fib.Map.Build.bin_11)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_12 Apps.Fib.Map.Build.bin_13)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_14 Apps.Fib.Map.Build.bin_15)\n      )\n    )\n  )   \n}\n#kdl_name = Fib_map_bq01\nApps.Fib.Map.Build.qui_01 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 ] U120 {\n  (Data.BaseTree.Bin.tie \n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_16 Apps.Fib.Map.Build.bin_17)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_18 Apps.Fib.Map.Build.bin_19)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_20 Apps.Fib.Map.Build.bin_21)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_22 Apps.Fib.Map.Build.bin_23)\n      )\n    )\n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_24 Apps.Fib.Map.Build.bin_25)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_26 Apps.Fib.Map.Build.bin_27)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_28 Apps.Fib.Map.Build.bin_29)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_30 Apps.Fib.Map.Build.bin_31)\n      )\n    )\n  )   \n}\n#kdl_name = Fib_map_bq02\nApps.Fib.Map.Build.qui_02 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 ] U120 {\n  (Data.BaseTree.Bin.tie \n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_32 Apps.Fib.Map.Build.bin_33)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_34 Apps.Fib.Map.Build.bin_35)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_36 Apps.Fib.Map.Build.bin_37)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_38 Apps.Fib.Map.Build.bin_39)\n      )\n    )\n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_40 Apps.Fib.Map.Build.bin_41)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_42 Apps.Fib.Map.Build.bin_43)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_44 Apps.Fib.Map.Build.bin_45)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_46 Apps.Fib.Map.Build.bin_47)\n      )\n    )\n  )   \n}\n#kdl_name = Fib_map_bq03\nApps.Fib.Map.Build.qui_03 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 ] U120 {\n  (Data.BaseTree.Bin.tie \n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_48 Apps.Fib.Map.Build.bin_49)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_50 Apps.Fib.Map.Build.bin_51)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_52 Apps.Fib.Map.Build.bin_53)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_54 Apps.Fib.Map.Build.bin_55)\n      )\n    )\n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_56 Apps.Fib.Map.Build.bin_57)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_58 Apps.Fib.Map.Build.bin_59)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_60 Apps.Fib.Map.Build.bin_61)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_62 Apps.Fib.Map.Build.bin_63)\n      )\n    )\n  )   \n}\n#kdl_name = Fib_map_bq04\nApps.Fib.Map.Build.qui_04 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 ] U120 {\n  (Data.BaseTree.Bin.tie \n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_64 Apps.Fib.Map.Build.bin_65)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_66 Apps.Fib.Map.Build.bin_67)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_68 Apps.Fib.Map.Build.bin_69)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_70 Apps.Fib.Map.Build.bin_71)\n      )\n    )\n    (Data.BaseTree.Bin.tie \n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_72 Apps.Fib.Map.Build.bin_73)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_74 Apps.Fib.Map.Build.bin_75)\n      )\n      (Data.BaseTree.Bin.tie \n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_76 Apps.Fib.Map.Build.bin_77)\n        (Data.BaseTree.Bin.tie Apps.Fib.Map.Build.bin_78 Apps.Fib.Map.Build.bin_79)\n      )\n    )\n  )   \n}\n#kdl_name = Fib_map_f32\nApps.Fib.Map.Build.full_32 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2] U120 {\n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))))) \n}\n#kdl_name = Fib_map_f16\nApps.Fib.Map.Build.full_16 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2] U120 {\n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))))\n}\n#kdl_name = Fib_map_f08\nApps.Fib.Map.Build.full_08 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2] U120 {\n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))))\n}\n#kdl_name = Fib_map_f04\nApps.Fib.Map.Build.full_04 : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2] U120 {\n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))\n}\n#kdl_name = Fib_map_f02\nApps.Fib.Map.Build.full_02 : Data.BaseTree [Data.BaseTree.Base.2] U120 {\n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))\n}"

stack = []
res = ''

file1 = open('map.txt', 'r')
lines = file1.readlines()

lines = lines[0].replace('(D', '\n(D').split('\n')
i = 0
index = 0
while i < len(lines):
    if len(lines[i].split(' ')) <= 2:
        stack.append(lines[i])
        i += 1
    else:
        x = str(index).zfill(2)
        a = "#kdl_name = Fib_map_p%s" % x + "\nApps.Fib.Map.Build.bin_%s : Data.BaseTree [Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2 Data.BaseTree.Base.2] U120 {" % x
        b = "}"
        res += a + '\n'
        for j in stack[-4:]:
            res += '  ' + j + '\n'
        for _ in range(27):
            res += '  ' + re.sub("[\)]{6,}", "))))))", lines[i]) + '\n'
            i += 1
        stack = []
        res += b + '\n'
        res += '\n'
        index += 1

branch_0 = "(Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))))))"
res = res.replace(branch_0, "Apps.Fib.Map.Build.full_32")
branch_1 = "(Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))))"
res = res.replace(branch_1, "Apps.Fib.Map.Build.full_16")
branch_2 = "(Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))) \n  (Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))))"
res = res.replace(branch_2, "Apps.Fib.Map.Build.full_08")
branch_3 = "(Data.BaseTree.Bin.tie \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)) \n  (Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705)))"
res = res.replace(branch_3, "Apps.Fib.Map.Build.full_04")
branch_4 = "(Data.BaseTree.Bin.tie (U120.new 281543712968705 281543712968705) (U120.new 281543712968705 281543712968705))"
res = res.replace(branch_4, "Apps.Fib.Map.Build.full_02")
f = open("Build_map.kind2", "w")
f.write(initial_string + res)
f.close()